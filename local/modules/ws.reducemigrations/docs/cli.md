##### [Главная страница](../README.md)

### Интерфейс командной строки

Основным требованием к любому функуионалу должно быть требование удобства использования. Это означает что:

 1. Все действия должны быть интуитивно понятны;
 2. Работая с функционалом нет нужды обращаться к документации.

Мы постарались сделать наиболее удобным использование модуля как при написании миграции так и при работе с очередью уже готовых миграций.

Основной интерфейс модуля - терминал. При использовании этого подхода есть неоспоримые приимущества:

 1. Время выполнения миграций не ограничено таймаутом сервера;
 2. Возможность автоматизировать обновление миграций совместно с обновлением кода. К примеру, можно интегрировать механизм обновления миграций
  при помощи функционала перехватчиков `СУРВ Git`

#### Начало работ

Файл для работы с миграцими через интерфейс командной строки расположен по пути `bitrix/tools/migrate`, таким образом запускать миграции через командную строку всегда нужно через этот файл.

Пример:

```sh
$ php bitrix/tools/migrate
```

Отображает список доступных действий

![Помощь](img/cli_help.png)

Можно получить более подробную информацию по каждому действию набрав ```--help``` после имени действия, к примеру:
```sh
$ php bitrix/tools/migrate create --help
```

![Справка](img/cli_action_help.png)
Выводится простая, но в то же время содержательная справка по параметрам действия и их использованию

#### Список миграций доступных для обновления

```sh
$ php bitrix/tools/migrate list
```

![Список подготовленных миграций](img/cli_list.png)

Миграции в списке группируются по приоритету, именно в таком порядке они будут обновляться. Так же выводится  суммарное время обновления согласно пустановленным периодам в сценариях. Это позволяет правильно ориентироваться по времени при обновлении.

#### Создание миграции

Интерактивный способ

```sh
$ php bitrix/tools/migrate create
```

![Список подготовленных миграций](img/cli_create_full.png)

Быстрый способ

![Список подготовленных миграций](img/cli_create_quick.png)

#### Применение подготовленных миграций

Запуск миграции по хешу.

```sh
$ php bitrix/tools/migrate apply a5468917
```

![Список подготовленных миграций](img/cli_apply_hash.png)

Из списка подготовленных миграций выбирается та, которая соответствует подстроке хеша.

Запуск всех миграций.

```sh
$ php bitrix/tools/migrate apply -f
```

![Список подготовленных миграций](img/cli_apply_all.png)

Флаг ```-f``` указывает на то что применение миграций начинать без запроса на подтверждение.

Запуск всех миграций.

```sh
$ php bitrix/tools/migrate apply -f --skip-optional
```

![Список подготовленных миграций](img/cli_apply_all.png)

Параметр ```--skip-optional``` указывает на пропуск опциональных миграций. Опциональные миграции создаются в основном для актуализаций боевой площадки и занимают продолжительное время, на площадках разработчиков такая актуализация не требуется и при обновлении миграций на площадке разработчика их можно пропустить.

Подойдет для обработчиков ```git```

#### История применения миграций

Все примененные миграции сохраняются в истории.

Последнее обновление миграций:
```sh
$ php bitrix/tools/migrate history
```

![Список подготовленных миграций](img/cli_history_last.png)

Просмотр истории по количеству последних миграций:
```sh
$ php bitrix/tools/migrate history
```

![Список подготовленных миграций](img/cli_history_count.png)

#### Откат миграций

Откат миграций производится через метод класса миграций ```rollback```

Откат последнего обновления:
```sh
$ php bitrix/tools/migrate rollback
```

![Список подготовленных миграций](img/cli_rollback_last.png)

Откат последнего обновления:
```sh
$ php bitrix/tools/migrate rollback
```

![Список подготовленных миграций](img/cli_rollback_last.png)

Откат одной миграции по хешу:
```sh
$ php bitrix/tools/migrate rollback b907dc51
```

![Список подготовленных миграций](img/cli_rollback_hash.png)

Откат определенного количества последних миграций:
```sh
$ php bitrix/tools/migrate rollback --count=2
```

![Список подготовленных миграций](img/cli_rollback_count.png)

Откат всех свежих миграций вплоть до определенной из списка:
Откат определенного количества последних миграций:
```sh
$ php bitrix/tools/migrate rollback --count=2
```

![Список подготовленных миграций](img/cli_rollback_up_to.png)

Применение и откат миграций сопровождается списком с перечнем того что будет обновляться или отменяться.
